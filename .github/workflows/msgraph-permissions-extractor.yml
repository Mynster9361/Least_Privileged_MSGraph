name: Microsoft Graph Permissions Extractor

on:
  workflow_dispatch:
    inputs:
      api_delay:
        description: 'Delay between API calls (ms)'
        required: false
        default: '100'
        type: string
      test_mode:
        description: 'Enable test mode'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'
      skip_count:
        description: 'Skip first N endpoints (test mode only)'
        required: false
        default: '0'
        type: string
      limit_count:
        description: 'Limit to N endpoints (test mode only)'
        required: false
        default: '0'
        type: string
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: write

jobs:
  extract-permissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.16.0'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install js-yaml axios
        
    - name: Download Microsoft Graph metadata
      run: |
        echo "Downloading Microsoft Graph metadata repository..."
        git clone --depth=1 https://github.com/microsoftgraph/msgraph-metadata.git temp-metadata
        
        # Create openapi directory structure
        mkdir -p openapi/v1.0
        mkdir -p openapi/beta
        
        # Copy the OpenAPI files
        if [ -f temp-metadata/openapi/v1.0/openapi.yaml ]; then
          cp temp-metadata/openapi/v1.0/openapi.yaml openapi/v1.0/
          echo "Copied v1.0 OpenAPI file"
        else
          echo "Warning: v1.0 OpenAPI file not found"
          ls -la temp-metadata/openapi/ || echo "openapi directory not found"
        fi
        
        if [ -f temp-metadata/openapi/beta/openapi.yaml ]; then
          cp temp-metadata/openapi/beta/openapi.yaml openapi/beta/
          echo "Copied beta OpenAPI file"
        else
          echo "Warning: beta OpenAPI file not found"
          ls -la temp-metadata/openapi/ || echo "openapi directory not found"
        fi
        
        # Clean up temporary directory
        rm -rf temp-metadata
        
        # Verify files exist
        echo "Verifying OpenAPI files:"
        ls -la openapi/v1.0/ || echo "v1.0 directory empty"
        ls -la openapi/beta/ || echo "beta directory empty"
        
    - name: Extract permissions data (Ultra-Fast Mode)
      run: node tools/run-production.js
      if: ${{ github.event.inputs.test_mode != 'true' }}
      
    - name: Extract permissions data (Test Mode)
      run: node tools/permissions-extractor.js
      if: ${{ github.event.inputs.test_mode == 'true' }}
      env:
        API_DELAY: ${{ github.event.inputs.api_delay || '10' }}
        TEST_MODE: 'true'
        SKIP_COUNT: ${{ github.event.inputs.skip_count || '0' }}
        LIMIT_COUNT: ${{ github.event.inputs.limit_count || '0' }}
        CONCURRENT_REQUESTS: '50'
        MAX_CONCURRENT_BATCHES: '5'
      
    - name: Create output directory and move files
      run: |
        mkdir -p data
        
        if [ -f permissions-v1.0.json ]; then
          mv permissions-v1.0.json data/
          echo "Moved v1.0 permissions file"
        else
          echo "Warning: permissions-v1.0.json not found"
        fi
        
        if [ -f permissions-beta.json ]; then
          mv permissions-beta.json data/
          echo "Moved beta permissions file"
        else
          echo "Warning: permissions-beta.json not found"
        fi
        
    - name: Generate summary report
      run: |
        echo "# Microsoft Graph Permissions Extraction Report" > data/extraction-summary.md
        echo "Generated on: $(date)" >> data/extraction-summary.md
        echo "" >> data/extraction-summary.md
        
        if [ -f data/permissions-v1.0.json ]; then
          v10_endpoints=$(jq length data/permissions-v1.0.json)
          v10_methods=$(jq '[.[].Method | keys | length] | add' data/permissions-v1.0.json)
          echo "## v1.0 Results" >> data/extraction-summary.md
          echo "- Endpoints: $v10_endpoints" >> data/extraction-summary.md
          echo "- Total Methods: $v10_methods" >> data/extraction-summary.md
          echo "" >> data/extraction-summary.md
        fi
        
        if [ -f data/permissions-beta.json ]; then
          beta_endpoints=$(jq length data/permissions-beta.json)
          beta_methods=$(jq '[.[].Method | keys | length] | add' data/permissions-beta.json)
          echo "## Beta Results" >> data/extraction-summary.md
          echo "- Endpoints: $beta_endpoints" >> data/extraction-summary.md
          echo "- Total Methods: $beta_methods" >> data/extraction-summary.md
        fi
        
    - name: Check for changes
      id: changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add the files
        git add data/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
        fi
        
    - name: Display summary
      run: |
        echo "## Extraction Summary"
        if [ -f data/extraction-summary.md ]; then
          cat data/extraction-summary.md
        fi
        
    - name: Commit and Push Changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git commit -m "Update Microsoft Graph permissions data [skip ci]
        
        - Updated $(date '+%Y-%m-%d %H:%M:%S UTC')
        - Extraction mode: ${{ github.event.inputs.test_mode == 'true' && 'Test' || 'Production' }}
        - Files updated: $(ls -1 data/*.json | wc -l) permission files"
        
        git push

    - name: Send Discord Notification
      if: steps.changes.outputs.has_changes == 'true'
      shell: pwsh
      run: |
        $webhookUrl = "${{ secrets.DISCORD_WEBHOOK_URL }}"
        
        # Read the summary data
        $v10Exists = Test-Path "data/permissions-v1.0.json"
        $betaExists = Test-Path "data/permissions-beta.json"
        
        if ($v10Exists) {
          $v10Data = Get-Content "data/permissions-v1.0.json" | ConvertFrom-Json
          $v10Endpoints = $v10Data.Count
          $v10Methods = ($v10Data | ForEach-Object { $_.Method.PSObject.Properties.Count } | Measure-Object -Sum).Sum
        } else {
          $v10Endpoints = 0
          $v10Methods = 0
        }
        
        if ($betaExists) {
          $betaData = Get-Content "data/permissions-beta.json" | ConvertFrom-Json
          $betaEndpoints = $betaData.Count
          $betaMethods = ($betaData | ForEach-Object { $_.Method.PSObject.Properties.Count } | Measure-Object -Sum).Sum
        } else {
          $betaEndpoints = 0
          $betaMethods = 0
        }
        
        $extractionMode = if ("${{ github.event.inputs.test_mode }}" -eq "true") { "Test Mode" } else { "Production Mode" }
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC"
        $repositoryUrl = "${{ github.server_url }}/${{ github.repository }}"
        $commitUrl = "$repositoryUrl/commit/${{ github.sha }}"
        
        # Create Discord embed
        $embed = @{
          title = "ðŸ”„ Microsoft Graph Permissions Updated"
          description = "New permissions data has been extracted and committed to the repository."
          color = 3066993  # Green color
          fields = @(
            @{
              name = "ðŸ“Š v1.0 API"
              value = "**Endpoints:** $v10Endpoints`n**Methods:** $v10Methods"
              inline = $true
            },
            @{
              name = "ðŸ§ª Beta API"
              value = "**Endpoints:** $betaEndpoints`n**Methods:** $betaMethods"
              inline = $true
            },
            @{
              name = "âš™ï¸ Extraction Info"
              value = "**Mode:** $extractionMode`n**Updated:** $timestamp"
              inline = $false
            }
          )
          footer = @{
            text = "Least Privileged MSGraph"
          }
          timestamp = (Get-Date).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
        }
        
        # Add links if not in test mode
        if ("${{ github.event.inputs.test_mode }}" -ne "true") {
          $embed.fields += @{
            name = "ðŸ”— Links"
            value = "[ðŸ“ Repository]($repositoryUrl) â€¢ [ðŸ“ Latest Commit]($commitUrl)"
            inline = $false
          }
        }
        
        $payload = @{
          username = "Graph Permissions Bot"
          avatar_url = "https://github.com/microsoft.png"
          embeds = @($embed)
        } | ConvertTo-Json -Depth 10
        
        # Send webhook
        try {
          $headers = @{
            "Content-Type" = "application/json"
          }
          
          Invoke-RestMethod -Uri $webhookUrl -Method Post -Body $payload -Headers $headers
          Write-Output "âœ… Discord notification sent successfully"
        }
        catch {
          Write-Output "âŒ Failed to send Discord notification: $($_.Exception.Message)"
          Write-Output "Payload was: $payload"
        }
        
    - name: Debug information
      if: failure()
      run: |
        echo "=== Debug Information ==="
        echo "Current directory contents:"
        ls -la
        echo ""
        echo "Data directory contents:"
        ls -la data/ 2>/dev/null || echo "No data directory found"
        echo ""
        echo "Git status:"
        git status