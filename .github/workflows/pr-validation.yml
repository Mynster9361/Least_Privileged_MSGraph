name: Pull Request Validation
# Handles: quick validation of PRs (build, test, code analysis, docs)
# Triggers: pull requests only

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to validate'
        required: false
        default: 'main'
        type: string

env:
  buildFolderName: output
  testResultFolderName: testResults

jobs:
  validate:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      MANUAL_VERSION: 0.1.0-pr${{ github.event.number || github.run_number }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display Version Info
        shell: pwsh
        run: |
          Write-Host "Manual Version: $env:MANUAL_VERSION"

      - name: Build Module
        shell: pwsh
        run: |
          ./build.ps1 -ResolveDependency -Tasks build
        env:
          ModuleVersion: ${{ env.MANUAL_VERSION }}

      - name: Run Tests
        shell: pwsh
        run: |
          ./build.ps1 -Tasks test

      - name: Generate Documentation
        shell: pwsh
        run: |
          ./build.ps1 -Tasks docs

      - name: Check Documentation Changes
        shell: pwsh
        run: |
          # Check if documentation was generated/updated
          $docsPath = "./output/docs"
          if (Test-Path $docsPath) {
            $docFiles = Get-ChildItem -Path $docsPath -Recurse -Filter "*.md"
            Write-Host "‚úÖ Generated $($docFiles.Count) documentation files:" -ForegroundColor Green
            $docFiles | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Warning "No documentation files were generated"
          }

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Import-Module -Name './output/RequiredModules/PSScriptAnalyzer' -Force
          $results = Invoke-ScriptAnalyzer -Path ./source -Recurse -ReportSummary
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Warning "PSScriptAnalyzer found $($results.Count) issues"
          } else {
            Write-Host "‚úÖ PSScriptAnalyzer found no issues" -ForegroundColor Green
          }

      - name: Commit generated documentation to PR branch
        if: github.event.pull_request.head.repo.full_name == github.repository
        shell: pwsh
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin "${{ github.event.pull_request.head.ref }}"
          git checkout "${{ github.event.pull_request.head.ref }}"
          $docs = Get-ChildItem -Path "./output/docs" -Filter "*.md" -Recurse
          if ($docs) {
            git add -f ./output/docs/*.md
            git commit -m "docs: auto-generate PowerShell help markdown" || echo "No changes to commit"
            git push origin "HEAD:${{ github.event.pull_request.head.ref }}"
          } else {
            echo "No docs to commit"
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Unit Test Results (PR Validation)
          path: ${{ env.buildFolderName }}/${{ env.testResultFolderName }}/*.xml

      - name: Upload Generated Documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Generated Documentation (PR Validation)
          path: ${{ env.buildFolderName }}/docs/
          retention-days: 7

  publish-test-results:
    name: "Publish PR Test Results"
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download Test Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Unit Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: artifacts/**/NUnit*.xml
          check_name: "PR Validation Results"
          action_fail: false
        continue-on-error: true

  documentation-preview:
    name: "Documentation Preview"
    needs: validate
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download Documentation Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Generated Documentation (PR Validation)
          path: docs-preview

      - name: Create Documentation Summary Markdown
        id: doc-summary
        shell: pwsh
        run: |
          $summary = ""
          if (Test-Path "./docs-preview") {
            $docFiles = Get-ChildItem -Path "./docs-preview" -Recurse -Filter "*.md"
            if ($docFiles.Count -gt 0) {
              $summary += "## üìö Generated Documentation`n"
              $summary += "The following documentation files were generated:`n"
              foreach ($file in $docFiles) {
                $summary += "- üìÑ $($file.Name)`n"
              }
              $summary += "`n> **Note**: Documentation is automatically generated from comment-based help in your PowerShell functions.`n"
            } else {
              $summary += "## ‚ö†Ô∏è No Documentation Generated`n"
              $summary += "No documentation files were generated. Make sure your functions have proper comment-based help.`n"
            }
          } else {
            $summary += "## ‚ö†Ô∏è No Documentation Generated`n"
            $summary += "No documentation files were generated. Make sure your functions have proper comment-based help.`n"
          }
          $summary | Set-Content doc-summary.md
          Get-Content doc-summary.md | Out-String | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          # Set output for next step
          $summary = Get-Content doc-summary.md -Raw
          echo "DOC_SUMMARY<<EOF" >> $env:GITHUB_OUTPUT
          echo "$summary" >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT

      - name: Comment on PR with Documentation Summary
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.doc-summary.outputs.DOC_SUMMARY }}
