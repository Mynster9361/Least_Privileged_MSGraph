<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>

    <script>
        // Dark mode initialization
        document.documentElement.classList.toggle('dark',
            localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
        );
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @import "tailwindcss";
        @custom-variant dark (&:where(.dark, .dark *));
        
        .severity-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>

    <link href="https://cdn.datatables.net/2.3.5/css/dataTables.dataTables.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.5/js/dataTables.min.js"></script>
    
    <style>
        /* DataTables controls */
        .dt-search input.dt-input,
        .dt-length select.dt-input {
            background-color: #f9fafb;
            color: #111827;
            border: 1px solid #d1d5db;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
        }
        
        .dt-search input.dt-input:focus,
        .dt-length select.dt-input:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
            border-color: #3b82f6;
        }
        
        /* Dark mode styles */
        .dark .dataTables_wrapper { color: #e5e7eb; }
        .dark .dt-layout-row, .dark .dt-layout-cell { color: #d1d5db; }
        .dark .dt-search label, .dark .dt-length label, .dark .dt-info { color: #d1d5db; }
        
        .dark .dt-search input.dt-input,
        .dark .dt-length select.dt-input {
            background-color: #374151;
            color: #e5e7eb;
            border-color: #4b5563;
        }
        
        .dark table.dataTable thead th {
            color: #d1d5db;
            border-bottom-color: #4b5563;
        }
        
        .dark table.dataTable tbody tr {
            background-color: #1f2937;
            color: #e5e7eb;
        }
        
        .dark table.dataTable.stripe tbody tr.odd { background-color: #374151; }
        .dark table.dataTable.hover tbody tr:hover { background-color: #4b5563; }
        .dark table.dataTable tbody td { border-top-color: #4b5563; }
        
        table.dataTable tbody td.sorting_1,
        table.dataTable tbody td.sorting_2,
        table.dataTable tbody td.sorting_3 {
            background-color: transparent !important;
        }
        
        .dark .dt-paging .dt-paging-button {
            color: #d1d5db !important;
            background: transparent;
            border: 1px solid transparent;
        }
        
        .dark .dt-paging .dt-paging-button:hover:not(.disabled) {
            color: #ffffff !important;
            background: #4b5563 !important;
            border-color: #4b5563 !important;
        }
        
        .dark .dt-paging .dt-paging-button.current {
            color: #ffffff !important;
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
        }
        
        .dark .dt-paging .dt-paging-button.disabled { color: #6b7280 !important; }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <div class="max-w-[70%] mx-auto px-4 py-8">
        
        <!-- Header -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 transition-colors duration-200">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">{% block title %}{% endblock %}</h1>
                <button id="themeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">
                    <svg class="w-6 h-6 hidden dark:block text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path>
                    </svg>
                    <svg class="w-6 h-6 block dark:hidden text-gray-700" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                </button>
            </div>
            <p class="text-gray-600 dark:text-gray-400">Generated on: {% block generated_on %}{% endblock %}</p>

            <!-- Statistics -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-blue-600 dark:text-blue-400 text-sm font-semibold">Total Applications</div>
                    <div class="text-2xl font-bold text-blue-900 dark:text-blue-300" id="totalApps">0</div>
                </div>
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-green-600 dark:text-green-400 text-sm font-semibold">Fully Matched</div>
                    <div class="text-2xl font-bold text-green-900 dark:text-green-300" id="fullyMatched">0</div>
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-yellow-600 dark:text-yellow-400 text-sm font-semibold">Excess Permissions</div>
                    <div class="text-2xl font-bold text-yellow-900 dark:text-yellow-300" id="withExcess">0</div>
                </div>
                <div class="bg-red-50 dark:bg-red-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-red-600 dark:text-red-400 text-sm font-semibold">Unmatched Activities</div>
                    <div class="text-2xl font-bold text-red-900 dark:text-red-300" id="withUnmatched">0</div>
                </div>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-purple-600 dark:text-purple-400 text-sm font-semibold">Apps Throttled</div>
                    <div class="text-2xl font-bold text-purple-900 dark:text-purple-300" id="throttledApps">0</div>
                </div>
                <div class="bg-orange-50 dark:bg-orange-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-orange-600 dark:text-orange-400 text-sm font-semibold">Critical Throttling</div>
                    <div class="text-2xl font-bold text-orange-900 dark:text-orange-300" id="criticalThrottling">0</div>
                </div>
                <div class="bg-indigo-50 dark:bg-indigo-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-indigo-600 dark:text-indigo-400 text-sm font-semibold">Total 429 Errors</div>
                    <div class="text-2xl font-bold text-indigo-900 dark:text-indigo-300" id="total429">0</div>
                </div>
                <div class="bg-pink-50 dark:bg-pink-900/30 rounded-lg p-4 transition-colors duration-200">
                    <div class="text-pink-600 dark:text-pink-400 text-sm font-semibold">Avg Throttle Rate</div>
                    <div class="text-2xl font-bold text-pink-900 dark:text-pink-300" id="avgThrottleRate">0%</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 transition-colors duration-200">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Permission Status</label>
                    <select id="statusFilter" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg p-2">
                        <option value="">All</option>
                        <option value="good">Optimal</option>
                        <option value="warning">Has Excess</option>
                        <option value="danger">Unmatched</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Activity Status</label>
                    <select id="activityFilter" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg p-2">
                        <option value="">All</option>
                        <option value="yes">Has Activity</option>
                        <option value="no">No Activity</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Throttling Severity</label>
                    <select id="throttlingFilter" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg p-2">
                        <option value="">All</option>
                        <option value="4">Critical</option>
                        <option value="3">Warning</option>
                        <option value="2">Low</option>
                        <option value="1">Minimal</option>
                        <option value="0">Normal</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search</label>
                    <input type="text" id="searchBox" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg p-2" placeholder="Search in the whole table...">
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 transition-colors duration-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Application Permission Analysis</h2>
                <button id="exportBtn" class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200">
                    Export to CSV
                </button>
            </div>
            <div class="overflow-x-auto">
                <table id="resultsTable" class="min-w-full display stripe hover">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Application Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Current Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Optimal Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Excess Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Missing Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Activities</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Throttling</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-gray-600 dark:bg-gray-900 bg-opacity-50 dark:bg-opacity-70 overflow-y-auto h-full w-full z-50 transition-colors duration-200">
        <div class="relative top-4 mx-auto p-5 border border-gray-300 dark:border-gray-600 w-11/12 max-w-[90%] shadow-lg rounded-lg bg-white dark:bg-gray-800 transition-colors duration-200" style="max-height: 92vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="modalTitle">Application Details</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-3xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="mt-4 overflow-y-auto dark:text-gray-200" style="max-height: calc(92vh - 120px);"></div>
        </div>
    </div>

    <script>
        const appData = JSON.parse("{% block app_data %}{% endblock %}");
        let dataTable;

        jQuery(document).ready(function() {
            initThemeToggle();
            updateStatistics();
            initDataTable();
            setupFilters();
            setupModal();
        });

        function initThemeToggle() {
            jQuery('#themeToggle').click(function() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
            });
        }

        function updateStatistics() {
            const stats = calculateStats(appData);
            jQuery('#totalApps').text(stats.total);
            jQuery('#fullyMatched').text(stats.fullyMatched);
            jQuery('#withExcess').text(stats.withExcess);
            jQuery('#withUnmatched').text(stats.withUnmatched);
            jQuery('#throttledApps').text(stats.throttledApps);
            jQuery('#criticalThrottling').text(stats.criticalThrottling);
            jQuery('#total429').text(stats.total429.toLocaleString());
            jQuery('#avgThrottleRate').text(stats.avgThrottleRate + '%');
        }

        function calculateStats(data) {
            const appsWithThrottling = data.filter(app => app.ThrottlingStats?.ThrottleRate);
            return {
                total: data.length,
                fullyMatched: data.filter(app => app.MatchedAllActivity && !app.ExcessPermissions?.length).length,
                withExcess: data.filter(app => app.ExcessPermissions?.length > 0).length,
                withUnmatched: data.filter(app => !app.MatchedAllActivity).length,
                throttledApps: data.filter(app => app.ThrottlingStats?.Total429Errors > 0).length,
                criticalThrottling: data.filter(app => app.ThrottlingStats?.ThrottlingSeverity === 4).length,
                total429: data.reduce((sum, app) => sum + (app.ThrottlingStats?.Total429Errors || 0), 0),
                avgThrottleRate: appsWithThrottling.length ? 
                    (appsWithThrottling.reduce((sum, app) => sum + app.ThrottlingStats.ThrottleRate, 0) / appsWithThrottling.length).toFixed(2) : 0
            };
        }

        function initDataTable() {
            dataTable = jQuery('#resultsTable').DataTable({
                data: prepareTableData(appData),
                pageLength: 25,
                order: [[7, 'desc']],
                columns: [
                    { data: 'appName', render: renderAppName },
                    { data: 'status', render: renderStatus },
                    { data: 'currentPerms', render: renderCurrentPerms },
                    { data: 'optimalPerms', render: renderOptimalPerms },
                    { data: 'excessPerms', render: renderExcessPerms },
                    { data: 'missingPerms', render: renderMissingPerms },
                    { data: 'activityCount', render: renderActivityCount },
                    { data: 'throttling', render: renderThrottling },
                    { data: 'index', orderable: false, render: renderDetailsButton }
                ]
            });

            // Custom search function to search through permissions
            jQuery.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                if (settings.nTable.id !== 'resultsTable') return true;
                
                const searchValue = jQuery('#searchBox').val().toLowerCase();
                if (!searchValue) return true;

                const rowData = dataTable.row(dataIndex).data();
                
                // Search in app name and ID
                if (rowData.appName.toLowerCase().includes(searchValue)) return true;
                if (rowData.appId.toLowerCase().includes(searchValue)) return true;
                
                // Search in current permissions
                if (rowData.currentPerms.some(p => p.toLowerCase().includes(searchValue))) return true;
                
                // Search in optimal permissions
                if (rowData.optimalPerms.some(p => p.Permission.toLowerCase().includes(searchValue))) return true;
                
                // Search in excess permissions
                if (rowData.excessPerms.some(p => p.toLowerCase().includes(searchValue))) return true;
                
                // Search in missing permissions
                if (rowData.missingPerms.some(p => p.toLowerCase().includes(searchValue))) return true;
                
                return false;
            });
        }

        function prepareTableData(data) {
            return data.map((app, index) => ({
                appName: app.PrincipalName || 'N/A',
                appId: app.PrincipalId || 'N/A',
                status: getAppStatus(app),
                currentPerms: toArray(app.CurrentPermissions),
                optimalPerms: toArray(app.OptimalPermissions),
                excessPerms: toArray(app.ExcessPermissions),
                missingPerms: toArray(app.RequiredPermissions),
                activityCount: toArray(app.Activity).length,
                throttling: app.ThrottlingStats ? {
                    total429: app.ThrottlingStats.Total429Errors || 0,
                    throttleRate: app.ThrottlingStats.ThrottleRate || 0,
                    status: app.ThrottlingStats.ThrottlingStatus || 'Normal',
                    severity: app.ThrottlingStats.ThrottlingSeverity || 0
                } : null,
                index: index
            }));
        }

        function toArray(val) {
            if (!val) return [];
            return Array.isArray(val) ? val : [val];
        }

        function getAppStatus(app) {
            if (!app.MatchedAllActivity) return 'danger';
            if (toArray(app.ExcessPermissions).length > 0) return 'warning';
            return 'good';
        }

        function renderAppName(data, type, row) {
            if (type !== 'display') return data;
            return '<div class="font-medium text-gray-900 dark:text-gray-100">' + data + 
                   '</div><div class="text-xs text-gray-500 dark:text-gray-400">' + row.appId + '</div>';
        }

        function renderStatus(data, type) {
            if (type !== 'display') return data;
            const badges = {
                good: '<div class="text-green-600 dark:text-green-400 font-semibold text-xs">Optimal</div>',
                warning: '<div class="text-orange-600 dark:text-orange-400 font-semibold text-xs">Excess</div>',
                danger: '<div class="text-red-600 dark:text-red-400 font-bold text-xs">Unmatched</div>'
            };
            return badges[data] || '';
        }

        function renderCurrentPerms(data, type) {
            if (type !== 'display') return data.length;
            let html = '<span class="font-semibold">' + data.length + '</span>';
            if (data.length > 0) {
                html += '<br><span class="text-xs text-gray-500 dark:text-gray-400">' + 
                        data.slice(0, 2).join(', ') + (data.length > 2 ? '...' : '') + '</span>';
            }
            return html;
        }

        function renderOptimalPerms(data, type) {
            if (type !== 'display') return data.length;
            let html = '<span class="font-semibold text-green-600 dark:text-green-400">' + data.length + '</span>';
            if (data.length > 0) {
                const names = data.map(p => p.Permission);
                html += '<br><span class="text-xs text-gray-500 dark:text-gray-400">' + 
                        names.slice(0, 2).join(', ') + (names.length > 2 ? '...' : '') + '</span>';
            }
            return html;
        }

        function renderExcessPerms(data, type) {
            if (type !== 'display') return data.length;
            const color = data.length > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400';
            let html = '<span class="font-semibold ' + color + '">' + data.length + '</span>';
            if (data.length > 0) {
                html += '<br><span class="text-xs text-red-500 dark:text-red-400">' + 
                        data.slice(0, 2).join(', ') + (data.length > 2 ? '...' : '') + '</span>';
            }
            return html;
        }

        function renderMissingPerms(data, type) {
            if (type !== 'display') return data.length;
            const color = data.length > 0 ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400';
            let html = '<span class="font-semibold ' + color + '">' + data.length + '</span>';
            if (data.length > 0) {
                html += '<br><span class="text-xs text-yellow-600 dark:text-yellow-400">' + 
                        data.slice(0, 2).join(', ') + (data.length > 2 ? '...' : '') + '</span>';
            }
            return html;
        }

        function renderActivityCount(data, type) {
            if (type !== 'display') return data;
            let html = '<span class="font-semibold">' + data + '</span>';
            html += data > 0 ? 
                '<span class="text-xs text-gray-500 dark:text-gray-400"><br>endpoints</span>' : 
                '<span class="text-xs text-gray-400 dark:text-gray-500"><br>No activity</span>';
            return html;
        }

        function renderThrottling(data, type) {
            if (type !== 'display') return data?.severity || 0;
            if (!data) return '<span class="text-xs text-gray-400 dark:text-gray-500">No data</span>';
            
            const statusColors = {
                4: 'text-red-600 dark:text-red-400 font-bold',
                3: 'text-orange-600 dark:text-orange-400 font-semibold',
                2: 'text-yellow-600 dark:text-yellow-400',
                1: 'text-blue-500 dark:text-blue-400',
                0: 'text-green-600 dark:text-green-400'
            };
            
            let html = '<div class="' + (statusColors[data.severity] || statusColors[0]) + ' font-semibold text-xs">' + 
                       (data.status || 'Normal') + '</div>';
            if (data.total429 > 0) {
                html += '<div class="text-xs text-gray-600 dark:text-gray-400">' + 
                        data.total429.toLocaleString() + ' errors (' + data.throttleRate + '%)</div>';
            }
            return html;
        }

        function renderDetailsButton(data) {
            return '<button onclick="showDetails(' + data + ')" ' +
                   'class="bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded text-xs transition-colors duration-200">' +
                   'View Details</button>';
        }

        function setupFilters() {
            jQuery('#statusFilter').change(function() {
                dataTable.column(1).search(jQuery(this).val(), false, false).draw();
            });

            jQuery('#activityFilter').change(function() {
                const val = jQuery(this).val();
                const search = val === 'yes' ? '^[1-9]' : val === 'no' ? '^0$' : '';
                dataTable.column(6).search(search, true, false).draw();
            });

            jQuery('#throttlingFilter').change(function() {
                const val = jQuery(this).val();
                dataTable.column(7).search(val ? '^' + val + '$' : '', true, false).draw();
            });

            jQuery('#searchBox').keyup(function() {
                dataTable.draw();
            });

            jQuery('#exportBtn').click(exportToCSV);
        }

        function setupModal() {
            jQuery('#closeModal').click(() => jQuery('#detailsModal').addClass('hidden'));
            jQuery(window).click(function(e) {
                if (jQuery(e.target).is('#detailsModal')) {
                    jQuery('#detailsModal').addClass('hidden');
                }
            });
        }

        function showDetails(index) {
            const app = appData[index];
            jQuery('#modalTitle').text(app.PrincipalName || 'Application Details');
            jQuery('#modalContent').html(buildModalContent(app));
            jQuery('#detailsModal').removeClass('hidden');
        }

        function buildModalContent(app) {
            let content = '<div class="space-y-4">';
            content += buildAppInfo(app);
            if (app.ThrottlingStats) content += buildThrottlingStats(app.ThrottlingStats);
            content += buildPermissionSection('Current Permissions', toArray(app.CurrentPermissions));
            content += buildOptimalPermissionSection(toArray(app.OptimalPermissions));
            content += buildPermissionSection('Excess Permissions', toArray(app.ExcessPermissions), 'text-red-600 dark:text-red-400');
            content += buildPermissionSection('Missing Permissions', toArray(app.RequiredPermissions), 'text-yellow-600 dark:text-yellow-400');
            content += buildActivitySection(toArray(app.Activity));
            content += buildUnmatchedSection(toArray(app.UnmatchedActivities));
            content += '</div>';
            return content;
        }

        function buildAppInfo(app) {
            return '<div class="border-b dark:border-gray-600 pb-4">' +
                   '<h4 class="font-bold text-lg mb-2 dark:text-gray-100">Application Information</h4>' +
                   '<p class="dark:text-gray-300"><span class="font-semibold">Principal ID:</span> ' + app.PrincipalId + '</p>' +
                   '<p class="dark:text-gray-300"><span class="font-semibold">Total App Roles:</span> ' + app.AppRoleCount + '</p>' +
                   '<p class="dark:text-gray-300"><span class="font-semibold">Matched All Activities:</span> ' + (app.MatchedAllActivity ? 'Yes' : 'No') + '</p>' +
                   '</div>';
        }

        function buildThrottlingStats(ts) {
            const severityBadges = {
                4: '<span class="severity-badge bg-red-600 text-white">Critical</span>',
                3: '<span class="severity-badge bg-orange-500 text-white">Warning</span>',
                2: '<span class="severity-badge bg-yellow-500 text-gray-800">Low</span>',
                1: '<span class="severity-badge bg-blue-500 text-white">Minimal</span>',
                0: '<span class="severity-badge bg-green-500 text-white">Normal</span>'
            };
            
            const statusColors = {
                'Critical': 'text-red-600 dark:text-red-400 font-bold',
                'Warning': 'text-orange-600 dark:text-orange-400 font-semibold',
                'Low': 'text-yellow-600 dark:text-yellow-400',
                'Minimal': 'text-blue-500 dark:text-blue-400'
            };
            
            let content = '<div class="border-b dark:border-gray-600 pb-4 bg-purple-50 dark:bg-purple-900/30 p-4 rounded">' +
                         '<h4 class="font-bold text-lg mb-2 text-purple-700 dark:text-purple-300">Throttling Statistics ' + 
                         (severityBadges[ts.ThrottlingSeverity] || severityBadges[0]) + '</h4>' +
                         '<div class="grid grid-cols-2 gap-2 text-sm dark:text-gray-300">';
            
            const stats = [
                ['Status', '<span class="' + (statusColors[ts.ThrottlingStatus] || 'text-green-600 dark:text-green-400') + '">' + ts.ThrottlingStatus + '</span>'],
                ['Severity', ts.ThrottlingSeverity + '/4'],
                ['Total Requests', (ts.TotalRequests || 0).toLocaleString()],
                ['Successful Requests', (ts.SuccessfulRequests || 0).toLocaleString()],
                ['429 Errors', '<span class="text-red-600 dark:text-red-400 font-bold">' + (ts.Total429Errors || 0).toLocaleString() + '</span>'],
                ['Throttle Rate', '<span class="text-red-600 dark:text-red-400 font-bold">' + (ts.ThrottleRate || 0) + '%</span>'],
                ['Client Errors (4xx)', (ts.TotalClientErrors || 0).toLocaleString()],
                ['Server Errors (5xx)', (ts.TotalServerErrors || 0).toLocaleString()],
                ['Success Rate', '<span class="text-green-600 dark:text-green-400">' + (ts.SuccessRate || 0) + '%</span>'],
                ['Error Rate', (ts.ErrorRate || 0) + '%']
            ];
            
            if (ts.FirstOccurrence) stats.push(['First Seen', new Date(ts.FirstOccurrence).toLocaleString()]);
            if (ts.LastOccurrence) stats.push(['Last Seen', new Date(ts.LastOccurrence).toLocaleString()]);
            
            stats.forEach(([label, value]) => {
                content += '<div><span class="font-semibold">' + label + ':</span> ' + value + '</div>';
            });
            
            return content + '</div></div>';
        }

        function buildPermissionSection(title, perms, colorClass = '') {
            if (!perms.length) return '';
            return '<div class="border-b dark:border-gray-600 pb-4">' +
                   '<h4 class="font-bold text-lg mb-2 ' + (colorClass || 'dark:text-gray-100') + '">' + title + ' (' + perms.length + ')</h4>' +
                   '<ul class="list-disc list-inside text-sm space-y-1 ' + (colorClass || 'dark:text-gray-300') + '">' +
                   perms.map(p => '<li>' + p + '</li>').join('') +
                   '</ul></div>';
        }

        function buildOptimalPermissionSection(perms) {
            if (!perms.length) return '';
            return '<div class="border-b dark:border-gray-600 pb-4">' +
                   '<h4 class="font-bold text-lg mb-2 text-green-600 dark:text-green-400">Optimal Permissions (' + perms.length + ')</h4>' +
                   '<ul class="list-disc list-inside text-sm space-y-1 dark:text-gray-300">' +
                   perms.map(p => '<li><span class="font-medium">' + p.Permission + '</span> (Covers ' + p.ActivitiesCovered + ' activities)</li>').join('') +
                   '</ul></div>';
        }

        function buildActivitySection(activities) {
            if (!activities.length) return '';
            return '<div><h4 class="font-bold text-lg mb-2 dark:text-gray-100">API Activities (' + activities.length + ')</h4>' +
                   '<div class="max-h-64 overflow-y-auto"><table class="min-w-full text-sm dark:text-gray-300">' +
                   '<thead class="bg-gray-50 dark:bg-gray-700 sticky top-0"><tr>' +
                   '<th class="px-2 py-2 text-left">Method</th><th class="px-2 py-2 text-left">Endpoint</th>' +
                   '</tr></thead><tbody>' +
                   activities.map(a => '<tr class="border-b dark:border-gray-600">' +
                       '<td class="px-2 py-2 font-mono text-xs">' + a.Method + '</td>' +
                       '<td class="px-2 py-2 font-mono text-xs break-all">' + a.Uri + '</td>' +
                       '</tr>').join('') +
                   '</tbody></table></div></div>';
        }

        function buildUnmatchedSection(unmatched) {
            if (!unmatched.length) return '';
            return '<div class="bg-red-50 dark:bg-red-900/30 p-4 rounded">' +
                   '<h4 class="font-bold text-lg mb-2 text-red-600 dark:text-red-400">Unmatched Activities (' + unmatched.length + ')</h4>' +
                   '<ul class="list-disc list-inside text-sm space-y-1 text-red-700 dark:text-red-400">' +
                   unmatched.map(a => '<li>' + a.Method + ' ' + a.Path + '</li>').join('') +
                   '</ul></div>';
        }

        function exportToCSV() {
            const headers = ['Application Name', 'Principal ID', 'Status', 'Current Permissions', 'Current Permission Count', 
                           'Optimal Permissions', 'Optimal Permission Count', 'Excess Permissions', 'Excess Permission Count', 
                           'Missing Permissions', 'Missing Permission Count', 'Activity Count', 'Matched All Activities', 
                           'Throttling Severity', 'Throttling Status', 'Total 429 Errors', 'Throttle Rate', 'Total Requests', 
                           'Success Rate', 'Error Rate'];
            
            let csv = headers.join(';') + '\n';
            
            appData.forEach(app => {
                const currentPerms = toArray(app.CurrentPermissions);
                const optimalPerms = toArray(app.OptimalPermissions);
                const excessPerms = toArray(app.ExcessPermissions);
                const missingPerms = toArray(app.RequiredPermissions);
                const activities = toArray(app.Activity);
                
                const row = [
                    '"' + (app.PrincipalName || '').replace(/"/g, '""') + '"',
                    '"' + (app.PrincipalId || '').replace(/"/g, '""') + '"',
                    getAppStatus(app),
                    '"' + currentPerms.join(', ').replace(/"/g, '""') + '"',
                    currentPerms.length,
                    '"' + optimalPerms.map(p => p.Permission).join(', ').replace(/"/g, '""') + '"',
                    optimalPerms.length,
                    '"' + excessPerms.join(', ').replace(/"/g, '""') + '"',
                    excessPerms.length,
                    '"' + missingPerms.join(', ').replace(/"/g, '""') + '"',
                    missingPerms.length,
                    activities.length,
                    app.MatchedAllActivity ? 'Yes' : 'No',
                    app.ThrottlingStats?.ThrottlingSeverity || 0,
                    app.ThrottlingStats ? '"' + (app.ThrottlingStats.ThrottlingStatus || 'Normal').replace(/"/g, '""') + '"' : 'No Data',
                    app.ThrottlingStats?.Total429Errors || 0,
                    app.ThrottlingStats?.ThrottleRate || 0,
                    app.ThrottlingStats?.TotalRequests || 0,
                    app.ThrottlingStats?.SuccessRate || 0,
                    app.ThrottlingStats?.ErrorRate || 0
                ];
                csv += row.join(';') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'permission_analysis_' + Date.now() + '.csv';
            link.click();
        }
    </script>
</body>
</html>