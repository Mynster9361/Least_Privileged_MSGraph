<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css" rel="stylesheet">
    <style>
        .severity-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-[70%] mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">{% block title %}{% endblock %}</h1>
            <p class="text-gray-600">Generated on: {% block generated_on %}{% endblock %}</p>
            
            <!-- Permission Statistics -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-blue-600 text font-semibold">Total Applications</div>
                    <div class="text-2xl font-bold text-blue-900" id="totalApps">0</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-green-600 text font-semibold">Fully Matched</div>
                    <div class="text-2xl font-bold text-green-900" id="fullyMatched">0</div>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4">
                    <div class="text-yellow-600 text font-semibold">Excess Permissions</div>
                    <div class="text-2xl font-bold text-yellow-900" id="withExcess">0</div>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <div class="text-red-600 text font-semibold">Unmatched Activities</div>
                    <div class="text-2xl font-bold text-red-900" id="withUnmatched">0</div>
                </div>
            </div>
            
            <!-- Throttling Statistics -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="text-purple-600 text font-semibold">Apps Throttled</div>
                    <div class="text-2xl font-bold text-purple-900" id="throttledApps">0</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <div class="text-orange-600 text font-semibold">Critical Throttling</div>
                    <div class="text-2xl font-bold text-orange-900" id="criticalThrottling">0</div>
                </div>
                <div class="bg-indigo-50 rounded-lg p-4">
                    <div class="text-indigo-600 text font-semibold">Total 429 Errors</div>
                    <div class="text-2xl font-bold text-indigo-900" id="total429">0</div>
                </div>
                <div class="bg-pink-50 rounded-lg p-4">
                    <div class="text-pink-600 text font-semibold">Avg Throttle Rate</div>
                    <div class="text-2xl font-bold text-pink-900" id="avgThrottleRate">0%</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text font-medium text-gray-700 mb-2">Permission Status</label>
                    <select id="statusFilter" class="w-full border border-gray-300 rounded-lg p-2">
                        <option value="">All</option>
                        <option value="good">Optimal</option>
                        <option value="warning">Has Excess</option>
                        <option value="danger">Unmatched</option>
                    </select>
                </div>
                <div>
                    <label class="block text font-medium text-gray-700 mb-2">Activity Status</label>
                    <select id="activityFilter" class="w-full border border-gray-300 rounded-lg p-2">
                        <option value="">All</option>
                        <option value="yes">Has Activity</option>
                        <option value="no">No Activity</option>
                    </select>
                </div>
                <div>
                    <label class="block text font-medium text-gray-700 mb-2">Throttling Severity</label>
                    <select id="throttlingFilter" class="w-full border border-gray-300 rounded-lg p-2">
                        <option value="">All</option>
                        <option value="4">Critical</option>
                        <option value="3">Warning</option>
                        <option value="2">Low</option>
                        <option value="1">Minimal</option>
                        <option value="0">Normal</option>
                    </select>
                </div>
                <div>
                    <label class="block text font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="searchBox" class="w-full border border-gray-300 rounded-lg p-2" placeholder="Search by app name...">
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Application Permission Analysis</h2>
                <button id="exportBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                    Export to CSV
                </button>
            </div>
            <div class="overflow-x-auto">
                <table id="resultsTable" class="min-w-full bg-white display stripe hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Optimal Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Excess Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Missing Permissions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activities</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Throttling</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-4 mx-auto p-5 border w-11/12 max-w-[90%] shadow-lg rounded-lg bg-white" style="max-height: 92vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-900" id="modalTitle">Application Details</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="mt-4 overflow-y-auto" style="max-height: calc(92vh - 120px);">
                <!-- Modal content will be populated here -->
            </div>
        </div>
    </div>

    <script>
        const appData = JSON.parse("{% block app_data %}{% endblock %}");
        let dataTable;
        let originalData = [];

        jQuery(document).ready(function() {
            console.log('Loaded', appData.length, 'applications');

            // Calculate statistics
            const stats = {
                total: appData.length,
                fullyMatched: appData.filter(app => app.MatchedAllActivity && (!app.ExcessPermissions || app.ExcessPermissions.length === 0)).length,
                withExcess: appData.filter(app => app.ExcessPermissions && app.ExcessPermissions.length > 0).length,
                withUnmatched: appData.filter(app => !app.MatchedAllActivity).length,
                throttledApps: appData.filter(app => app.ThrottlingStats && app.ThrottlingStats.Total429Errors > 0).length,
                criticalThrottling: appData.filter(app => app.ThrottlingStats && app.ThrottlingStats.ThrottlingSeverity === 4).length,
                total429: appData.reduce((sum, app) => sum + (app.ThrottlingStats?.Total429Errors || 0), 0),
                avgThrottleRate: 0
            };
            
            const appsWithThrottling = appData.filter(app => app.ThrottlingStats && app.ThrottlingStats.ThrottleRate);
            if (appsWithThrottling.length > 0) {
                stats.avgThrottleRate = (appsWithThrottling.reduce((sum, app) => sum + app.ThrottlingStats.ThrottleRate, 0) / appsWithThrottling.length).toFixed(2);
            }

            jQuery('#totalApps').text(stats.total);
            jQuery('#fullyMatched').text(stats.fullyMatched);
            jQuery('#withExcess').text(stats.withExcess);
            jQuery('#withUnmatched').text(stats.withUnmatched);
            jQuery('#throttledApps').text(stats.throttledApps);
            jQuery('#criticalThrottling').text(stats.criticalThrottling);
            jQuery('#total429').text(stats.total429.toLocaleString());
            jQuery('#avgThrottleRate').text(stats.avgThrottleRate + '%');

            // Prepare data for DataTables
            originalData = prepareTableData(appData);

            // Initialize DataTable with proper column definitions
            dataTable = jQuery('#resultsTable').DataTable({
                data: originalData,
                pageLength: 25,
                order: [[7, 'desc']],
                columns: [
                    {
                        data: 'appName',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return '<div class="font-medium text-gray-900">' + data + '</div><div class="text-xs text-gray-500">' + row.appId + '</div>';
                            }
                            return data;
                        }
                    },
                    {
                        data: 'status',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return getStatusBadge(data);
                            }
                            return data;
                        }
                    },
                    {
                        data: 'currentPerms',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                let html = '<span class="font-semibold">' + data.length + '</span>';
                                if (data.length > 0) {
                                    html += '<br><span class="text-xs text-gray-500">' + data.slice(0, 2).join(', ') + (data.length > 2 ? '...' : '') + '</span>';
                                }
                                return html;
                            }
                            return data.length;
                        }
                    },
                    {
                        data: 'optimalPerms',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                let html = '<span class="font-semibold text-green-600">' + data.length + '</span>';
                                if (data.length > 0) {
                                    const names = data.map(p => p.Permission);
                                    html += '<br><span class="text-xs text-gray-500">' + names.slice(0, 2).join(', ') + (names.length > 2 ? '...' : '') + '</span>';
                                }
                                return html;
                            }
                            return data.length;
                        }
                    },
                    {
                        data: 'excessPerms',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                let html = '<span class="font-semibold ' + (data.length > 0 ? 'text-red-600' : 'text-green-600') + '">' + data.length + '</span>';
                                if (data.length > 0) {
                                    html += '<br><span class="text-xs text-red-500">' + data.slice(0, 2).join(', ') + (data.length > 2 ? '...' : '') + '</span>';
                                }
                                return html;
                            }
                            return data.length;
                        }
                    },
                    {
                        data: 'missingPerms',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                let html = '<span class="font-semibold ' + (data.length > 0 ? 'text-yellow-600' : 'text-green-600') + '">' + data.length + '</span>';
                                if (data.length > 0) {
                                    html += '<br><span class="text-xs text-yellow-600">' + data.slice(0, 2).join(', ') + (data.length > 2 ? '...' : '') + '</span>';
                                }
                                return html;
                            }
                            return data.length;
                        }
                    },
                    {
                        data: 'activityCount',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                let html = '<span class="font-semibold">' + data + '</span>';
                                html += data > 0 ? '<span class="text-xs text-gray-500"><br>endpoints</span>' : '<span class="text-xs text-gray-400"><br>No activity</span>';
                                return html;
                            }
                            return data;
                        }
                    },
                    {
                        data: 'throttling',
                        render: function(data, type, row) {
                            if (type === 'display') {
                                if (!data) return '<span class="text-xs text-gray-400">No data</span>';
                                
                                let statusClass = 'text-green-600';
                                
                                if (data.severity === 4) {
                                    statusClass = 'text-red-600 font-bold';
                                } else if (data.severity === 3) {
                                    statusClass = 'text-orange-600 font-semibold';
                                } else if (data.severity === 2) {
                                    statusClass = 'text-yellow-600';
                                } else if (data.severity === 1) {
                                    statusClass = 'text-blue-500';
                                }
                                
                                let html = '<div class="' + statusClass + ' font-semibold text-xs">' + (data.status || 'Normal') + '</div>';
                                if (data.total429 > 0) {
                                    html += '<div class="text-xs text-gray-600">' + data.total429.toLocaleString() + ' errors (' + data.throttleRate + '%)</div>';
                                }
                                return html;
                            }
                            return data?.severity || 0;
                        }
                    },
                    {
                        data: 'index',
                        orderable: false,
                        render: function(data, type, row) {
                            return '<button onclick="showDetails(' + data + ')" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded text-xs">View Details</button>';
                        }
                    }
                ]
            });

            // Filters
            jQuery('#statusFilter').change(function() {
                const value = jQuery(this).val();
                dataTable.column(1).search(value, false, false).draw();
            });

            jQuery('#activityFilter').change(function() {
                const value = jQuery(this).val();
                if (value === 'yes') {
                    dataTable.column(6).search('^[1-9]', true, false).draw();
                } else if (value === 'no') {
                    dataTable.column(6).search('^0$', true, false).draw();
                } else {
                    dataTable.column(6).search('').draw();
                }
            });

            jQuery('#throttlingFilter').change(function() {
                const value = jQuery(this).val();
                if (value) {
                    dataTable.column(7).search('^' + value + '$', true, false).draw();
                } else {
                    dataTable.column(7).search('').draw();
                }
            });

            jQuery('#searchBox').keyup(function() {
                dataTable.search(jQuery(this).val()).draw();
            });

            jQuery('#exportBtn').click(function() {
                exportToCSV();
            });

            jQuery('#closeModal').click(function() {
                jQuery('#detailsModal').addClass('hidden');
            });

            jQuery(window).click(function(event) {
                if (jQuery(event.target).is('#detailsModal')) {
                    jQuery('#detailsModal').addClass('hidden');
                }
            });
        });

        function prepareTableData(data) {
            return data.map((app, index) => {
                const currentPerms = Array.isArray(app.CurrentPermissions) ? app.CurrentPermissions : (app.CurrentPermissions ? [app.CurrentPermissions] : []);
                const optimalPerms = Array.isArray(app.OptimalPermissions) ? app.OptimalPermissions : (app.OptimalPermissions ? [app.OptimalPermissions] : []);
                const excessPerms = Array.isArray(app.ExcessPermissions) ? app.ExcessPermissions : (app.ExcessPermissions ? [app.ExcessPermissions] : []);
                const missingPerms = Array.isArray(app.RequiredPermissions) ? app.RequiredPermissions : (app.RequiredPermissions ? [app.RequiredPermissions] : []);
                const activityCount = app.Activity ? (Array.isArray(app.Activity) ? app.Activity.length : 1) : 0;
                
                const throttling = app.ThrottlingStats ? {
                    total429: app.ThrottlingStats.Total429Errors || 0,
                    throttleRate: app.ThrottlingStats.ThrottleRate || 0,
                    status: app.ThrottlingStats.ThrottlingStatus || 'Normal',
                    severity: app.ThrottlingStats.ThrottlingSeverity || 0
                } : null;

                return {
                    appName: app.PrincipalName || 'N/A',
                    appId: app.PrincipalId || 'N/A',
                    status: getStatus(app),
                    currentPerms: currentPerms,
                    optimalPerms: optimalPerms,
                    excessPerms: excessPerms,
                    missingPerms: missingPerms,
                    activityCount: activityCount,
                    throttling: throttling,
                    index: index
                };
            });
        }

        function getStatus(app) {
            if (!app.MatchedAllActivity) return 'danger';
            if (app.ExcessPermissions && ((Array.isArray(app.ExcessPermissions) && app.ExcessPermissions.length > 0) || (!Array.isArray(app.ExcessPermissions) && app.ExcessPermissions))) return 'warning';
            return 'good';
        }

        function getStatusBadge(status) {
            const badges = {
                good: '<div class="text-green-600 font-semibold text-xs">Optimal</div>',
                warning: '<div class="text-orange-600 font-semibold text-xs">Excess</div>',
                danger: '<div class="text-red-600 font-bold text-xs">Unmatched</div>'
            };
            return badges[status] || '';
        }

        function getSeverityBadge(severity) {
            const badges = {
                4: '<span class="severity-badge bg-red-600 text-white">Critical</span>',
                3: '<span class="severity-badge bg-orange-500 text-white">Warning</span>',
                2: '<span class="severity-badge bg-yellow-500 text-gray-800">Low</span>',
                1: '<span class="severity-badge bg-blue-500 text-white">Minimal</span>',
                0: '<span class="severity-badge bg-green-500 text-white">Normal</span>'
            };
            return badges[severity] || badges[0];
        }

        function getThrottlingStatusClass(status) {
            if (!status) return '';
            if (status === 'Critical') return 'text-red-600 font-bold';
            if (status === 'Warning') return 'text-orange-600 font-semibold';
            if (status === 'Low') return 'text-yellow-600';
            if (status === 'Minimal') return 'text-blue-500';
            return 'text-green-600';
        }

        function showDetails(index) {
            const app = appData[index];
            jQuery('#modalTitle').text(app.PrincipalName || 'Application Details');

            let content = '<div class="space-y-4"><div class="border-b pb-4"><h4 class="font-bold text-lg mb-2">Application Information</h4>';
            content += '<p><span class="font-semibold">Principal ID:</span> ' + app.PrincipalId + '</p>';
            content += '<p><span class="font-semibold">Total App Roles:</span> ' + app.AppRoleCount + '</p>';
            content += '<p><span class="font-semibold">Matched All Activities:</span> ' + (app.MatchedAllActivity ? 'Yes' : 'No') + '</p></div>';

            if (app.ThrottlingStats) {
                const ts = app.ThrottlingStats;
                content += '<div class="border-b pb-4 bg-purple-50 p-4 rounded"><h4 class="font-bold text-lg mb-2 text-purple-700">Throttling Statistics ' + getSeverityBadge(ts.ThrottlingSeverity) + '</h4>';
                content += '<div class="grid grid-cols-2 gap-2 text">';
                content += '<div><span class="font-semibold">Status:</span> <span class="' + getThrottlingStatusClass(ts.ThrottlingStatus) + '">' + ts.ThrottlingStatus + '</span></div>';
                content += '<div><span class="font-semibold">Severity:</span> ' + ts.ThrottlingSeverity + '/4</div>';
                content += '<div><span class="font-semibold">Total Requests:</span> ' + (ts.TotalRequests || 0).toLocaleString() + '</div>';
                content += '<div><span class="font-semibold">Successful Requests:</span> ' + (ts.SuccessfulRequests || 0).toLocaleString() + '</div>';
                content += '<div><span class="font-semibold">429 Errors:</span> <span class="text-red-600 font-bold">' + (ts.Total429Errors || 0).toLocaleString() + '</span></div>';
                content += '<div><span class="font-semibold">Throttle Rate:</span> <span class="text-red-600 font-bold">' + (ts.ThrottleRate || 0) + '%</span></div>';
                content += '<div><span class="font-semibold">Client Errors (4xx):</span> ' + (ts.TotalClientErrors || 0).toLocaleString() + '</div>';
                content += '<div><span class="font-semibold">Server Errors (5xx):</span> ' + (ts.TotalServerErrors || 0).toLocaleString() + '</div>';
                content += '<div><span class="font-semibold">Success Rate:</span> <span class="text-green-600">' + (ts.SuccessRate || 0) + '%</span></div>';
                content += '<div><span class="font-semibold">Error Rate:</span> ' + (ts.ErrorRate || 0) + '%</div>';
                
                if (ts.FirstOccurrence) {
                    content += '<div><span class="font-semibold">First Seen:</span> ' + new Date(ts.FirstOccurrence).toLocaleString() + '</div>';
                }
                if (ts.LastOccurrence) {
                    content += '<div><span class="font-semibold">Last Seen:</span> ' + new Date(ts.LastOccurrence).toLocaleString() + '</div>';
                }
                
                content += '</div></div>';
            }

            const currentPerms = Array.isArray(app.CurrentPermissions) ? app.CurrentPermissions : (app.CurrentPermissions ? [app.CurrentPermissions] : []);
            if (currentPerms.length > 0) {
                content += '<div class="border-b pb-4"><h4 class="font-bold text-lg mb-2">Current Permissions (' + currentPerms.length + ')</h4><ul class="list-disc list-inside text space-y-1">';
                currentPerms.forEach(p => { content += '<li>' + p + '</li>'; });
                content += '</ul></div>';
            }

            const optimalPerms = Array.isArray(app.OptimalPermissions) ? app.OptimalPermissions : [];
            if (optimalPerms.length > 0) {
                content += '<div class="border-b pb-4"><h4 class="font-bold text-lg mb-2 text-green-600">Optimal Permissions (' + optimalPerms.length + ')</h4><ul class="list-disc list-inside text space-y-1">';
                optimalPerms.forEach(p => { content += '<li><span class="font-medium">' + p.Permission + '</span> (Covers ' + p.ActivitiesCovered + ' activities)</li>'; });
                content += '</ul></div>';
            }

            const excessPerms = Array.isArray(app.ExcessPermissions) ? app.ExcessPermissions : (app.ExcessPermissions ? [app.ExcessPermissions] : []);
            if (excessPerms.length > 0) {
                content += '<div class="border-b pb-4"><h4 class="font-bold text-lg mb-2 text-red-600">Excess Permissions (' + excessPerms.length + ')</h4><ul class="list-disc list-inside text space-y-1 text-red-600">';
                excessPerms.forEach(p => { content += '<li>' + p + '</li>'; });
                content += '</ul></div>';
            }

            const missingPerms = Array.isArray(app.RequiredPermissions) ? app.RequiredPermissions : (app.RequiredPermissions ? [app.RequiredPermissions] : []);
            if (missingPerms.length > 0) {
                content += '<div class="border-b pb-4"><h4 class="font-bold text-lg mb-2 text-yellow-600">Missing Permissions (' + missingPerms.length + ')</h4><ul class="list-disc list-inside text space-y-1 text-yellow-600">';
                missingPerms.forEach(p => { content += '<li>' + p + '</li>'; });
                content += '</ul></div>';
            }

            const activities = Array.isArray(app.Activity) ? app.Activity : (app.Activity ? [app.Activity] : []);
            if (activities.length > 0) {
                content += '<div><h4 class="font-bold text-lg mb-2">API Activities (' + activities.length + ')</h4><div class="max-h-64 overflow-y-auto"><table class="min-w-full text"><thead class="bg-gray-50 sticky top-0"><tr><th class="px-2 py-2 text-left">Method</th><th class="px-2 py-2 text-left">Endpoint</th></tr></thead><tbody>';
                activities.forEach(a => { content += '<tr class="border-b"><td class="px-2 py-2 font-mono text-xs">' + a.Method + '</td><td class="px-2 py-2 font-mono text-xs break-all">' + a.Uri + '</td></tr>'; });
                content += '</tbody></table></div></div>';
            }

            const unmatched = Array.isArray(app.UnmatchedActivities) ? app.UnmatchedActivities : [];
            if (unmatched.length > 0) {
                content += '<div class="bg-red-50 p-4 rounded"><h4 class="font-bold text-lg mb-2 text-red-600">Unmatched Activities (' + unmatched.length + ')</h4><ul class="list-disc list-inside text space-y-1 text-red-700">';
                unmatched.forEach(a => { content += '<li>' + a.Method + ' ' + a.Path + '</li>'; });
                content += '</ul></div>';
            }

            content += '</div>';
            jQuery('#modalContent').html(content);
            jQuery('#detailsModal').removeClass('hidden');
        }

        function exportToCSV() {
            let csv = 'Application Name;Principal ID;Status;Current Permissions;Current Permission Count;Optimal Permissions;Optimal Permission Count;Excess Permissions;Excess Permission Count;Missing Permissions;Missing Permission Count;Activity Count;Matched All Activities;Throttling Severity;Throttling Status;Total 429 Errors;Throttle Rate;Total Requests;Success Rate;Error Rate\n';

            appData.forEach(app => {
                const status = getStatus(app);
                const currentPerms = Array.isArray(app.CurrentPermissions) ? app.CurrentPermissions : (app.CurrentPermissions ? [app.CurrentPermissions] : []);
                const optimalPerms = Array.isArray(app.OptimalPermissions) ? app.OptimalPermissions : [];
                const excessPerms = Array.isArray(app.ExcessPermissions) ? app.ExcessPermissions : (app.ExcessPermissions ? [app.ExcessPermissions] : []);
                const missingPerms = Array.isArray(app.RequiredPermissions) ? app.RequiredPermissions : (app.RequiredPermissions ? [app.RequiredPermissions] : []);
                const activities = Array.isArray(app.Activity) ? app.Activity : (app.Activity ? [app.Activity] : []);

                const row = [
                    '"' + (app.PrincipalName || '').replace(/"/g, '""') + '"',
                    '"' + (app.PrincipalId || '').replace(/"/g, '""') + '"',
                    status,
                    '"' + currentPerms.join(', ').replace(/"/g, '""') + '"',
                    currentPerms.length,
                    '"' + optimalPerms.map(p => p.Permission).join(', ').replace(/"/g, '""') + '"',
                    optimalPerms.length,
                    '"' + excessPerms.join(', ').replace(/"/g, '""') + '"',
                    excessPerms.length,
                    '"' + missingPerms.join(', ').replace(/"/g, '""') + '"',
                    missingPerms.length,
                    activities.length,
                    app.MatchedAllActivity ? 'Yes' : 'No',
                    app.ThrottlingStats ? app.ThrottlingStats.ThrottlingSeverity : 0,
                    app.ThrottlingStats ? '"' + (app.ThrottlingStats.ThrottlingStatus || 'Normal').replace(/"/g, '""') + '"' : 'No Data',
                    app.ThrottlingStats ? (app.ThrottlingStats.Total429Errors || 0) : 0,
                    app.ThrottlingStats ? (app.ThrottlingStats.ThrottleRate || 0) : 0,
                    app.ThrottlingStats ? (app.ThrottlingStats.TotalRequests || 0) : 0,
                    app.ThrottlingStats ? (app.ThrottlingStats.SuccessRate || 0) : 0,
                    app.ThrottlingStats ? (app.ThrottlingStats.ErrorRate || 0) : 0
                ];
                csv += row.join(';') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'permission_analysis_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>